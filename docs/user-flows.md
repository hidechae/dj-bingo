# ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼è©³ç´°

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€DJ Bingoã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ä¸»è¦ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’è©³ç´°ã«èª¬æ˜ã—ã¾ã™ã€‚

## ç›®æ¬¡

1. [ç®¡ç†è€…ãƒ•ãƒ­ãƒ¼](#ç®¡ç†è€…ãƒ•ãƒ­ãƒ¼)
   - [ãƒ­ã‚°ã‚¤ãƒ³](#1-ãƒ­ã‚°ã‚¤ãƒ³)
   - [ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰](#2-ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰)
   - [ãƒ“ãƒ³ã‚´ã‚²ãƒ¼ãƒ ä½œæˆ](#3-ãƒ“ãƒ³ã‚´ã‚²ãƒ¼ãƒ ä½œæˆ)
   - [ã‚²ãƒ¼ãƒ ç®¡ç†](#4-ã‚²ãƒ¼ãƒ ç®¡ç†)
2. [å‚åŠ è€…ãƒ•ãƒ­ãƒ¼](#å‚åŠ è€…ãƒ•ãƒ­ãƒ¼)
   - [ã‚²ãƒ¼ãƒ å‚åŠ ](#1-ã‚²ãƒ¼ãƒ å‚åŠ )
   - [ã‚°ãƒªãƒƒãƒ‰è¨­å®š](#2-ã‚°ãƒªãƒƒãƒ‰è¨­å®š)
   - [ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤](#3-ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤)
3. [ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸãƒ•ãƒ­ãƒ¼](#ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸãƒ•ãƒ­ãƒ¼)
4. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](#ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°)

---

## ç®¡ç†è€…ãƒ•ãƒ­ãƒ¼

### 1. ãƒ­ã‚°ã‚¤ãƒ³

#### ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ

```
é–‹å§‹
  â†“
ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ (/)
  â†“
ã€Œç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ã€ã‚¯ãƒªãƒƒã‚¯
  â†“
/auth/signin
  â†“
èªè¨¼æ–¹æ³•ã‚’é¸æŠ
  â”œâ”€ Googleã§ãƒ­ã‚°ã‚¤ãƒ³
  â”‚    â†“
  â”‚  Google OAuthèªè¨¼ç”»é¢
  â”‚    â†“
  â”‚  èªè¨¼æˆåŠŸ
  â”œâ”€ Spotify OAuthã§ãƒ­ã‚°ã‚¤ãƒ³
  â”‚    â†“
  â”‚  Spotifyèªè¨¼ç”»é¢
  â”‚    â†“
  â”‚  èªè¨¼æˆåŠŸ
  â””â”€ Magic Linkã§ãƒ­ã‚°ã‚¤ãƒ³
       â†“
     ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›
       â†“
     ãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ³ã‚¯ã‚’ãƒ¡ãƒ¼ãƒ«ã§å—ä¿¡
       â†“
     èªè¨¼æˆåŠŸ
  â†“
NextAuth.jsãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
  â†“
/admin ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  â†“
çµ‚äº†
```

#### é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹                          | å½¹å‰²                                           |
| ------------------------------------- | ---------------------------------------------- |
| `src/pages/index.tsx`                 | ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã€ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«å¿œã˜ã¦è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ |
| `src/pages/auth/signin.tsx`           | ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸                         |
| `src/server/auth.ts`                  | NextAuth.jsè¨­å®šã€Google Providerã®è¨­å®š         |
| `src/pages/api/auth/[...nextauth].ts` | NextAuth.jsã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ                 |

#### é‡è¦ãªã‚³ãƒ¼ãƒ‰

**`src/pages/index.tsx` - ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç¢ºèª**

```tsx
const Home: NextPage = () => {
  const { data: session } = useSession();  // NextAuth.jsã‹ã‚‰èªè¨¼çŠ¶æ…‹ã‚’å–å¾—

  return (
    {session ? (
      // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿: ç®¡ç†è€…ç”»é¢ã¸ã®ãƒªãƒ³ã‚¯
      <Link href="/admin">ç®¡ç†è€…ç”»é¢ â†’</Link>
    ) : (
      // æœªãƒ­ã‚°ã‚¤ãƒ³: ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯
      <Link href="/auth/signin">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ â†’</Link>
    )}
  );
};
```

**`src/server/auth.ts` - èªè¨¼è¨­å®š**

```tsx
export const authOptions: NextAuthOptions = {
  adapter: PrismaAdapter(db), // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’DBã«ä¿å­˜
  providers: [
    // Google OAuth
    GoogleProvider({
      clientId: env.GOOGLE_CLIENT_ID,
      clientSecret: env.GOOGLE_CLIENT_SECRET,
    }),
    // Email & Password (bcryptjsã§ãƒãƒƒã‚·ãƒ¥åŒ–)
    CredentialsProvider({
      // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§èªè¨¼
    }),
  ],
  pages: {
    signIn: "/auth/signin", // ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
  },
};
```

#### çŠ¶æ…‹é·ç§»

| çŠ¶æ…‹                           | èª¬æ˜             |
| ------------------------------ | ---------------- |
| `status === "loading"`         | èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­ |
| `status === "unauthenticated"` | æœªãƒ­ã‚°ã‚¤ãƒ³       |
| `status === "authenticated"`   | ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿     |

---

### 2. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

#### ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ

```
/admin ã«ã‚¢ã‚¯ã‚»ã‚¹
  â†“
èªè¨¼ãƒã‚§ãƒƒã‚¯ (useSession)
  â”œâ”€ æœªãƒ­ã‚°ã‚¤ãƒ³ â†’ /auth/signin ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  â””â”€ ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿
       â†“
api.bingo.getAllByUser.useQuery() å®Ÿè¡Œ
  â†“
è‡ªåˆ†ãŒä½œæˆã—ãŸãƒ“ãƒ³ã‚´ã‚²ãƒ¼ãƒ ä¸€è¦§ã‚’å–å¾—
  â†“
ã‚²ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
  â”œâ”€ ã€Œç®¡ç†ã€ãƒªãƒ³ã‚¯ â†’ /admin/game/[id]
  â””â”€ ã€Œå‚åŠ ç”¨URLã€ãƒªãƒ³ã‚¯ â†’ /game/[id]
```

#### é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹                      | å½¹å‰²                     |
| --------------------------------- | ------------------------ |
| `src/pages/admin/index.tsx`       | ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰     |
| `src/server/api/routers/bingo.ts` | `getAllByUser` APIã®å®Ÿè£… |

#### é‡è¦ãªã‚³ãƒ¼ãƒ‰

**`src/pages/admin/index.tsx` - ã‚²ãƒ¼ãƒ ä¸€è¦§ã®å–å¾—**

```tsx
const AdminDashboard: NextPage = () => {
  const { data: session, status } = useSession();
  const { data: bingoGames, isLoading } = api.bingo.getAllByUser.useQuery(
    undefined,
    { enabled: !!session }  // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã®ã¿å®Ÿè¡Œ
  );

  // æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  useEffect(() => {
    if (status === "loading") return;
    if (!session) {
      void router.push("/auth/signin");
    }
  }, [session, status, router]);

  // ã‚²ãƒ¼ãƒ ä¸€è¦§ã‚’è¡¨ç¤º
  return (
    {bingoGames?.map((game) => (
      <div key={game.id}>
        <h3>{game.title}</h3>
        <Link href={`/admin/game/${game.id}`}>ç®¡ç†</Link>
        <Link href={`/game/${game.id}`}>å‚åŠ ç”¨URL</Link>
      </div>
    ))}
  );
};
```

**`src/server/api/routers/bingo.ts` - getAllByUser API**

```tsx
getAllByUser: protectedProcedure  // èªè¨¼å¿…é ˆ
  .query(async ({ ctx }) => {
    return await ctx.db.bingoGame.findMany({
      where: { createdBy: ctx.session.user.id },  // è‡ªåˆ†ãŒä½œæˆã—ãŸã‚²ãƒ¼ãƒ ã®ã¿
      include: {
        songs: true,
        participants: true,
      },
      orderBy: { createdAt: "desc" },
    });
  }),
```

---

### 3. ãƒ“ãƒ³ã‚´ã‚²ãƒ¼ãƒ ä½œæˆ

#### ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ

```
/admin/create ã«ã‚¢ã‚¯ã‚»ã‚¹
  â†“
ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›
  â”œâ”€ ã‚¿ã‚¤ãƒˆãƒ«
  â”œâ”€ ã‚µã‚¤ã‚º (3x3, 4x4, 5x5)
  â””â”€ æ¥½æ›²ãƒªã‚¹ãƒˆ (title, artist)
     â”œâ”€ å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¡¨ç¤º
     â””â”€ ã€Œæ¥½æ›²ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã§è¡Œè¿½åŠ 
  â†“
ã€Œãƒ“ãƒ³ã‚´ã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
  â†“
api.bingo.create.useMutation() å®Ÿè¡Œ
  â†“
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  â”œâ”€ ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã§ãªã„ã‹
  â”œâ”€ æ¥½æ›²æ•°ãŒååˆ†ã‹
  â”‚   â”œâ”€ 3x3: æœ€ä½9æ›²
  â”‚   â”œâ”€ 4x4: æœ€ä½16æ›²
  â”‚   â””â”€ 5x5: æœ€ä½25æ›²
  â””â”€ OK
       â†“
DBã«BingoGame + Songãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
  â†“
ä½œæˆæˆåŠŸ
  â†“
/admin/game/[id] ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
```

#### é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹                      | å½¹å‰²               |
| --------------------------------- | ------------------ |
| `src/pages/admin/create.tsx`      | ã‚²ãƒ¼ãƒ ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  |
| `src/server/api/routers/bingo.ts` | `create` APIã®å®Ÿè£… |

#### é‡è¦ãªã‚³ãƒ¼ãƒ‰

**`src/pages/admin/create.tsx` - ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡**

```tsx
const AdminCreate: NextPage = () => {
  const [title, setTitle] = useState("");
  const [size, setSize] = useState<BingoSize>(BingoSize.THREE_BY_THREE);
  const [songs, setSongs] = useState<{ title: string; artist?: string }[]>([]);

  const createMutation = api.bingo.create.useMutation({
    onSuccess: (data) => {
      // ä½œæˆæˆåŠŸ: ç®¡ç†ç”»é¢ã¸é·ç§»
      void router.push(`/admin/game/${data.id}`);
    },
    onError: (error) => {
      alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    },
  });

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    createMutation.mutate({ title, size, songs });
  };
};
```

**`src/server/api/routers/bingo.ts` - create API**

```tsx
create: protectedProcedure
  .input(
    z.object({
      title: z.string().min(1),
      size: z.nativeEnum(BingoSize),
      songs: z.array(
        z.object({
          title: z.string().min(1),
          artist: z.string().optional(),
        })
      ).min(1),
    })
  )
  .mutation(async ({ ctx, input }) => {
    const bingoGame = await ctx.db.bingoGame.create({
      data: {
        title: input.title,
        size: input.size,
        createdBy: ctx.session.user.id,
        songs: {
          create: input.songs,  // æ¥½æ›²ã‚‚åŒæ™‚ã«ä½œæˆ
        },
      },
      include: {
        songs: true,
        participants: true,
      },
    });

    return bingoGame;
  }),
```

---

### 4. ã‚²ãƒ¼ãƒ ç®¡ç†

#### ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ

```
/admin/game/[id] ã«ã‚¢ã‚¯ã‚»ã‚¹
  â†“
api.bingo.getById.useQuery() ã§ã‚²ãƒ¼ãƒ æƒ…å ±å–å¾—
  â”œâ”€ ã‚²ãƒ¼ãƒ æƒ…å ±
  â”œâ”€ æ¥½æ›²ãƒªã‚¹ãƒˆ
  â””â”€ å‚åŠ è€…ãƒªã‚¹ãƒˆ
  â†“
ç”»é¢è¡¨ç¤º
  â”œâ”€ QRã‚³ãƒ¼ãƒ‰ (å‚åŠ ç”¨URL)
  â”œâ”€ æ¥½æ›²ãƒªã‚¹ãƒˆ
  â”‚   â””â”€ å„æ¥½æ›²ã«ã€Œæ¼”å¥æ¸ˆã¿ã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
  â””â”€ å‚åŠ è€…ãƒªã‚¹ãƒˆ
      â”œâ”€ åå‰
      â”œâ”€ ã‚°ãƒªãƒƒãƒ‰è¨­å®šå®Œäº†çŠ¶æ…‹
      â””â”€ ãƒ“ãƒ³ã‚´é”æˆçŠ¶æ…‹
  â†“
æ¥½æ›²ã‚’ã€Œæ¼”å¥æ¸ˆã¿ã€ã«ã™ã‚‹
  â†“
api.bingo.markSongAsPlayed.useMutation()
  â†“
DBã®Song.isPlayedã‚’trueã«æ›´æ–°
  â†“
å‚åŠ è€…ç”»é¢ã«åæ˜ ï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°ã§è‡ªå‹•æ›´æ–°ï¼‰
```

#### é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹                      | å½¹å‰²                              |
| --------------------------------- | --------------------------------- |
| `src/pages/admin/game/[id].tsx`   | ã‚²ãƒ¼ãƒ ç®¡ç†ç”»é¢                    |
| `src/server/api/routers/bingo.ts` | `getById`, `markSongAsPlayed` API |

#### é‡è¦ãªã‚³ãƒ¼ãƒ‰

**`src/pages/admin/game/[id].tsx` - æ¥½æ›²ã®æ¼”å¥çŠ¶æ…‹æ›´æ–°**

```tsx
const AdminGameManage: NextPage = () => {
  const router = useRouter();
  const { id } = router.query;

  const { data: game } = api.bingo.getById.useQuery({ id: id as string });

  const markAsPlayedMutation = api.bingo.markSongAsPlayed.useMutation({
    onSuccess: () => {
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã—ã¦å†å–å¾—
      utils.bingo.getById.invalidate({ id: id as string });
    },
  });

  const handleTogglePlayed = (songId: string, isPlayed: boolean) => {
    markAsPlayedMutation.mutate({ songId, isPlayed });
  };

  return (
    <div>
      <h2>æ¥½æ›²ãƒªã‚¹ãƒˆ</h2>
      {game?.songs.map((song) => (
        <div key={song.id}>
          <input
            type="checkbox"
            checked={song.isPlayed}
            onChange={(e) => handleTogglePlayed(song.id, e.target.checked)}
          />
          {song.title} - {song.artist}
        </div>
      ))}
    </div>
  );
};
```

**`src/server/api/routers/bingo.ts` - markSongAsPlayed API**

```tsx
markSongAsPlayed: protectedProcedure
  .input(
    z.object({
      songId: z.string(),
      isPlayed: z.boolean(),
    })
  )
  .mutation(async ({ ctx, input }) => {
    const song = await ctx.db.song.update({
      where: { id: input.songId },
      data: {
        isPlayed: input.isPlayed,
        playedAt: input.isPlayed ? new Date() : null,
      },
    });

    return song;
  }),
```

---

## å‚åŠ è€…ãƒ•ãƒ­ãƒ¼

### 1. ã‚²ãƒ¼ãƒ å‚åŠ 

#### ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ

```
QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³
  â†“
/game/[id] ã«ã‚¢ã‚¯ã‚»ã‚¹
  â†“
localStorage ã‹ã‚‰ sessionToken å–å¾—
  â”œâ”€ å­˜åœ¨ã—ãªã„ â†’ æ–°è¦ç”Ÿæˆã—ã¦ä¿å­˜
  â””â”€ å­˜åœ¨ã™ã‚‹ â†’ ãã®ã¾ã¾ä½¿ç”¨
  â†“
api.participant.getBySessionToken.useQuery() å®Ÿè¡Œ
  â”œâ”€ æ—¢ã«å‚åŠ æ¸ˆã¿
  â”‚   â”œâ”€ isGridComplete === false â†’ /game/[id]/setup ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  â”‚   â””â”€ isGridComplete === true â†’ /game/[id]/play ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  â””â”€ æœªå‚åŠ 
       â†“
åå‰å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
  â†“
åå‰ã‚’å…¥åŠ›ã—ã¦ã€Œå‚åŠ ã™ã‚‹ã€ã‚¯ãƒªãƒƒã‚¯
  â†“
api.participant.join.useMutation() å®Ÿè¡Œ
  â†“
DBã«Participantãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
  â†“
/game/[id]/setup ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
```

#### é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹                            | å½¹å‰²                            |
| --------------------------------------- | ------------------------------- |
| `src/pages/game/[id].tsx`               | å‚åŠ ãƒšãƒ¼ã‚¸                      |
| `src/server/api/routers/participant.ts` | `join`, `getBySessionToken` API |

#### é‡è¦ãªã‚³ãƒ¼ãƒ‰

**`src/pages/game/[id].tsx` - sessionTokenç”Ÿæˆã¨å‚åŠ **

```tsx
const ParticipantGame: NextPage = () => {
  const router = useRouter();
  const { id } = router.query;
  const [sessionToken, setSessionToken] = useState<string>("");
  const [participantName, setParticipantName] = useState("");

  // sessionToken ã‚’ localStorage ã‹ã‚‰å–å¾—/ç”Ÿæˆ
  useEffect(() => {
    let token = localStorage.getItem("dj-bingo-session");
    if (!token) {
      token = Math.random().toString(36).substring(2) + Date.now().toString(36);
      localStorage.setItem("dj-bingo-session", token);
    }
    setSessionToken(token);
  }, []);

  // æ—¢ã«å‚åŠ æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
  const { data: participant } = api.participant.getBySessionToken.useQuery(
    { sessionToken },
    { enabled: !!sessionToken }
  );

  // å‚åŠ æ¸ˆã¿ãªã‚‰é©åˆ‡ãªãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  useEffect(() => {
    if (participant && participant.bingoGameId === id) {
      if (!participant.isGridComplete) {
        void router.push(`/game/${id}/setup`);
      } else {
        void router.push(`/game/${id}/play`);
      }
    }
  }, [participant, id, router]);

  // å‚åŠ å‡¦ç†
  const joinMutation = api.participant.join.useMutation({
    onSuccess: () => {
      // ã‚°ãƒªãƒƒãƒ‰è¨­å®šãƒšãƒ¼ã‚¸ã¸é·ç§»
    },
  });

  const handleJoin = (e: React.FormEvent) => {
    e.preventDefault();
    joinMutation.mutate({
      name: participantName,
      bingoGameId: id as string,
      sessionToken,
    });
  };
};
```

**`src/server/api/routers/participant.ts` - join API**

```tsx
join: publicProcedure  // èªè¨¼ä¸è¦
  .input(
    z.object({
      name: z.string().min(1),
      bingoGameId: z.string(),
      sessionToken: z.string(),
    })
  )
  .mutation(async ({ ctx, input }) => {
    // ã‚²ãƒ¼ãƒ ãŒå­˜åœ¨ã—ã¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‹ç¢ºèª
    const bingoGame = await ctx.db.bingoGame.findUnique({
      where: { id: input.bingoGameId },
    });

    if (!bingoGame || !bingoGame.isActive) {
      throw new TRPCError({
        code: "NOT_FOUND",
        message: "Bingo game not found or inactive",
      });
    }

    // æ—¢ã«å‚åŠ æ¸ˆã¿ã‹ç¢ºèª
    const existingParticipant = await ctx.db.participant.findUnique({
      where: { sessionToken: input.sessionToken },
    });

    if (existingParticipant) {
      throw new TRPCError({
        code: "CONFLICT",
        message: "Already joined this game",
      });
    }

    // æ–°è¦å‚åŠ è€…ä½œæˆ
    const participant = await ctx.db.participant.create({
      data: {
        name: input.name,
        bingoGameId: input.bingoGameId,
        sessionToken: input.sessionToken,
      },
    });

    return participant;
  }),
```

---

### 2. ã‚°ãƒªãƒƒãƒ‰è¨­å®š

#### ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ

```
/game/[id]/setup ã«ã‚¢ã‚¯ã‚»ã‚¹
  â†“
api.bingo.getById.useQuery() ã§ã‚²ãƒ¼ãƒ æƒ…å ±å–å¾—
  â””â”€ æ¥½æ›²ãƒªã‚¹ãƒˆå–å¾—
  â†“
ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºã«å¿œã˜ãŸç©ºã®ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º
  â”œâ”€ 3x3: 9ãƒã‚¹
  â”œâ”€ 4x4: 16ãƒã‚¹
  â””â”€ 5x5: 25ãƒã‚¹
  â†“
æ¥½æ›²ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠã—ã¦ã‚°ãƒªãƒƒãƒ‰ã«é…ç½®
  â”œâ”€ ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ
  â””â”€ ã‚°ãƒªãƒƒãƒ‰ã®å„ãƒã‚¹ã«æ¥½æ›²ã‚’å‰²ã‚Šå½“ã¦
  â†“
ã™ã¹ã¦ã®ãƒã‚¹ãŒåŸ‹ã¾ã£ãŸã‹ç¢ºèª
  â†“
ã€Œãƒ“ãƒ³ã‚´ã‚’é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
  â†“
api.participant.setupGrid.useMutation() å®Ÿè¡Œ
  â†“
ParticipantSongãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ
  â””â”€ participantId, songId, position
  â†“
isGridComplete = true ã«æ›´æ–°
  â†“
/game/[id]/play ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
```

#### é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹                            | å½¹å‰²             |
| --------------------------------------- | ---------------- |
| `src/pages/game/[id]/setup.tsx`         | ã‚°ãƒªãƒƒãƒ‰è¨­å®šç”»é¢ |
| `src/server/api/routers/participant.ts` | `setupGrid` API  |

#### é‡è¦ãªã‚³ãƒ¼ãƒ‰

**`src/pages/game/[id]/setup.tsx` - ã‚°ãƒªãƒƒãƒ‰è¨­å®š**

```tsx
const SetupGrid: NextPage = () => {
  const router = useRouter();
  const { id } = router.query;
  const [sessionToken, setSessionToken] = useState("");
  const [selectedSongs, setSelectedSongs] = useState<(string | null)[]>([]);

  const { data: game } = api.bingo.getById.useQuery({ id: id as string });

  // ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºã«å¿œã˜ã¦åˆæœŸåŒ–
  useEffect(() => {
    if (game) {
      const gridSize = getGridSize(game.size); // 9, 16, 25
      setSelectedSongs(new Array(gridSize).fill(null));
    }
  }, [game]);

  const setupGridMutation = api.participant.setupGrid.useMutation({
    onSuccess: () => {
      void router.push(`/game/${id}/play`);
    },
  });

  const handleSubmit = () => {
    // é¸æŠã—ãŸæ¥½æ›²ã¨ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
    const grid = selectedSongs.map((songId, index) => ({
      songId: songId!,
      position: index,
    }));

    setupGridMutation.mutate({ sessionToken, grid });
  };

  return (
    <div>
      <h2>æ¥½æ›²ã‚’ã‚°ãƒªãƒƒãƒ‰ã«é…ç½®ã—ã¦ãã ã•ã„</h2>
      {/* ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º */}
      <div className="grid grid-cols-3">
        {selectedSongs.map((songId, index) => (
          <div key={index}>
            {songId ? (
              <SongCard songId={songId} />
            ) : (
              <EmptySlot onSelect={(id) => handleSelectSong(index, id)} />
            )}
          </div>
        ))}
      </div>
      <button onClick={handleSubmit}>ãƒ“ãƒ³ã‚´ã‚’é–‹å§‹</button>
    </div>
  );
};
```

**`src/server/api/routers/participant.ts` - setupGrid API**

```tsx
setupGrid: publicProcedure
  .input(
    z.object({
      sessionToken: z.string(),
      grid: z.array(
        z.object({
          songId: z.string(),
          position: z.number(),
        })
      ),
    })
  )
  .mutation(async ({ ctx, input }) => {
    // å‚åŠ è€…ã‚’å–å¾—
    const participant = await ctx.db.participant.findUnique({
      where: { sessionToken: input.sessionToken },
    });

    if (!participant) {
      throw new TRPCError({ code: "NOT_FOUND" });
    }

    // ParticipantSongãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä¸€æ‹¬ä½œæˆ
    await ctx.db.participantSong.createMany({
      data: input.grid.map((item) => ({
        participantId: participant.id,
        songId: item.songId,
        position: item.position,
      })),
    });

    // isGridComplete ã‚’ true ã«æ›´æ–°
    const updatedParticipant = await ctx.db.participant.update({
      where: { id: participant.id },
      data: { isGridComplete: true },
    });

    return updatedParticipant;
  }),
```

---

### 3. ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤

#### ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ

```
/game/[id]/play ã«ã‚¢ã‚¯ã‚»ã‚¹
  â†“
api.participant.getBySessionToken.useQuery()
  â”œâ”€ refetchInterval: 3000 (3ç§’ã”ã¨ã«ãƒãƒ¼ãƒªãƒ³ã‚°)
  â””â”€ å‚åŠ è€…æƒ…å ± + ã‚°ãƒªãƒƒãƒ‰ + æ¥½æ›²ã®æ¼”å¥çŠ¶æ…‹ã‚’å–å¾—
  â†“
ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º
  â”œâ”€ æ¼”å¥æ¸ˆã¿æ¥½æ›²ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
  â””â”€ æœªæ¼”å¥æ¥½æ›²ã¯é€šå¸¸è¡¨ç¤º
  â†“
ç®¡ç†è€…ãŒæ¥½æ›²ã‚’ã€Œæ¼”å¥æ¸ˆã¿ã€ã«ã™ã‚‹
  â†“
3ç§’ä»¥å†…ã«ãƒãƒ¼ãƒªãƒ³ã‚°ã§æ›´æ–°
  â†“
ç”»é¢ãŒè‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã‚‹
  â”œâ”€ æ¼”å¥æ¸ˆã¿æ¥½æ›²ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã‚‹
  â””â”€ ãƒ“ãƒ³ã‚´é”æˆã®å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
  â†“
ãƒ“ãƒ³ã‚´ãƒ©ã‚¤ãƒ³ãŒæƒã£ãŸï¼Ÿ
  â”œâ”€ YES â†’ api.participant.checkWin.useMutation()
  â”‚          â†“
  â”‚       hasWon = true, wonAt = now()
  â”‚          â†“
  â”‚       ã€Œãƒ“ãƒ³ã‚´ï¼ã€ç”»é¢è¡¨ç¤º
  â””â”€ NO â†’ ç¶™ç¶š
```

#### é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹                            | å½¹å‰²                                |
| --------------------------------------- | ----------------------------------- |
| `src/pages/game/[id]/play.tsx`          | ãƒ—ãƒ¬ã‚¤ç”»é¢                          |
| `src/server/api/routers/participant.ts` | `getBySessionToken`, `checkWin` API |

#### é‡è¦ãªã‚³ãƒ¼ãƒ‰

**`src/pages/game/[id]/play.tsx` - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°**

```tsx
const PlayGame: NextPage = () => {
  const [sessionToken, setSessionToken] = useState("");

  // 3ç§’ã”ã¨ã«ãƒãƒ¼ãƒªãƒ³ã‚°
  const { data: participant } = api.participant.getBySessionToken.useQuery(
    { sessionToken },
    {
      enabled: !!sessionToken,
      refetchInterval: 3000, // 3ç§’ã”ã¨
    }
  );

  const checkWinMutation = api.participant.checkWin.useMutation();

  // ãƒ“ãƒ³ã‚´åˆ¤å®š
  useEffect(() => {
    if (participant && !participant.hasWon) {
      // ãƒ“ãƒ³ã‚´ãƒ©ã‚¤ãƒ³ãŒæƒã£ãŸã‹ãƒã‚§ãƒƒã‚¯
      if (hasWinningLine(participant.participantSongs)) {
        checkWinMutation.mutate({ sessionToken });
      }
    }
  }, [participant]);

  return (
    <div>
      {participant?.hasWon ? (
        <div>ğŸ‰ ãƒ“ãƒ³ã‚´ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</div>
      ) : (
        <div>
          <h2>ãƒ“ãƒ³ã‚´ã‚°ãƒªãƒƒãƒ‰</h2>
          <Grid songs={participant?.participantSongs} />
        </div>
      )}
    </div>
  );
};
```

**`src/server/api/routers/participant.ts` - checkWin API**

```tsx
checkWin: publicProcedure
  .input(z.object({ sessionToken: z.string() }))
  .mutation(async ({ ctx, input }) => {
    const participant = await ctx.db.participant.findUnique({
      where: { sessionToken: input.sessionToken },
      include: {
        participantSongs: {
          include: { song: true },
        },
        bingoGame: true,
      },
    });

    if (!participant) {
      throw new TRPCError({ code: "NOT_FOUND" });
    }

    // ãƒ“ãƒ³ã‚´åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
    const hasWon = checkBingo(participant);

    if (hasWon && !participant.hasWon) {
      // åˆã‚ã¦ã®ãƒ“ãƒ³ã‚´é”æˆ
      const updated = await ctx.db.participant.update({
        where: { id: participant.id },
        data: {
          hasWon: true,
          wonAt: new Date(),
        },
      });
      return updated;
    }

    return participant;
  }),
```

---

## ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸãƒ•ãƒ­ãƒ¼

### ãƒãƒ¼ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹åŒæœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç®¡ç†è€…ç”»é¢   â”‚                  â”‚  å‚åŠ è€…ç”»é¢   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                 â”‚
       â”‚ markSongAsPlayed()              â”‚
       â”‚ (æ¥½æ›²ã‚’æ¼”å¥æ¸ˆã¿ã«ã™ã‚‹)            â”‚
       â–¼                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚   Database   â”‚                        â”‚
â”‚  Song.isPlayed                        â”‚
â”‚  = true      â”‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
       â–²                                 â”‚
       â”‚                                 â”‚
       â”‚                          3ç§’ã”ã¨ã«ãƒãƒ¼ãƒªãƒ³ã‚°
       â”‚                                 â”‚
       â”‚                          getBySessionToken()
       â”‚                                 â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                    ç”»é¢æ›´æ–°
                                  (æ¼”å¥æ¸ˆã¿è¡¨ç¤º)
```

### ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ã®è¨­å®š

```tsx
// æ¨å¥¨: 3ç§’
const { data } = api.participant.getBySessionToken.useQuery(
  { sessionToken },
  { refetchInterval: 3000 }
);

// é«˜é »åº¦æ›´æ–°ãŒå¿…è¦ãªå ´åˆ: 1ç§’
{
  refetchInterval: 1000;
}

// ã‚µãƒ¼ãƒãƒ¼è² è·ã‚’æŠ‘ãˆã‚‹å ´åˆ: 5ç§’
{
  refetchInterval: 5000;
}
```

---

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ç®¡ç†è€…å´ã®ã‚¨ãƒ©ãƒ¼

| ã‚¨ãƒ©ãƒ¼               | åŸå›                           | å¯¾å‡¦                         |
| -------------------- | ----------------------------- | ---------------------------- |
| `UNAUTHORIZED`       | æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã§APIã‚’å‘¼ã³å‡ºã— | `/auth/signin`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ |
| `NOT_FOUND`          | å­˜åœ¨ã—ãªã„ã‚²ãƒ¼ãƒ IDã‚’æŒ‡å®š      | ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º         |
| ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ | æ¥½æ›²æ•°ãŒä¸è¶³ã€ãªã©            | ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒ©ãƒ¼è¡¨ç¤º           |

### å‚åŠ è€…å´ã®ã‚¨ãƒ©ãƒ¼

| ã‚¨ãƒ©ãƒ¼               | åŸå›                | å¯¾å‡¦                               |
| -------------------- | ------------------ | ---------------------------------- |
| `NOT_FOUND`          | ç„¡åŠ¹ãªã‚²ãƒ¼ãƒ ID     | ã€Œã‚²ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€è¡¨ç¤º     |
| `CONFLICT`           | æ—¢ã«å‚åŠ æ¸ˆã¿       | è‡ªå‹•çš„ã«é©åˆ‡ãªãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ |
| ã‚²ãƒ¼ãƒ ãŒéã‚¢ã‚¯ãƒ†ã‚£ãƒ– | `isActive = false` | ã€Œã‚²ãƒ¼ãƒ ã¯çµ‚äº†ã—ã¾ã—ãŸã€è¡¨ç¤º       |

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å®Ÿè£…ä¾‹

```tsx
const createMutation = api.bingo.create.useMutation({
  onSuccess: (data) => {
    // æˆåŠŸæ™‚ã®å‡¦ç†
    void router.push(`/admin/game/${data.id}`);
  },
  onError: (error) => {
    // ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
    if (error.data?.code === "UNAUTHORIZED") {
      void router.push("/auth/signin");
    } else {
      alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    }
  },
});
```

---

## ã¾ã¨ã‚

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€DJ Bingoã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸»è¦ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’è©³ç´°ã«èª¬æ˜ã—ã¾ã—ãŸã€‚

### é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

1. **ç®¡ç†è€…ãƒ•ãƒ­ãƒ¼**: èªè¨¼å¿…é ˆï¼ˆMagic Linkã€Google OAuthã€Spotify OAuthï¼‰ã€protectedProcedureã§ä¿è­·
2. **å‚åŠ è€…ãƒ•ãƒ­ãƒ¼**: èªè¨¼ä¸è¦ã€sessionTokenã§è­˜åˆ¥
3. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°**: ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆ3ç§’é–“éš”ï¼‰ã§å®Ÿç¾
4. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: tRPCã®ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã§é©åˆ‡ã«å‡¦ç†
5. **ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†**: EDITING â†’ ENTRY â†’ PLAYING â†’ FINISHED ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«
6. **å…±åŒç®¡ç†æ©Ÿèƒ½**: è¤‡æ•°ã®ç®¡ç†è€…ã§1ã¤ã®ã‚²ãƒ¼ãƒ ã‚’ç®¡ç†å¯èƒ½

### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](./architecture.md) - ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®è¨­è¨ˆæ€æƒ³
- [ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰](./code-reading-guide.md) - ã‚³ãƒ¼ãƒ‰ã®è©³ç´°ãªèª­ã¿æ–¹
- [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](./troubleshooting/README.md) - ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•
